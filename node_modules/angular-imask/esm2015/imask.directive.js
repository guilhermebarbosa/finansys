/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, ElementRef, Input, Output, forwardRef, Renderer2, EventEmitter, Optional, Inject, } from '@angular/core';
import { NG_VALUE_ACCESSOR, COMPOSITION_BUFFER_MODE } from '@angular/forms';
import { IMaskFactory } from "./imask-factory";
/** @type {?} */
export const MASKEDINPUT_VALUE_ACCESSOR = {
    provide: NG_VALUE_ACCESSOR,
    useExisting: forwardRef((/**
     * @return {?}
     */
    () => IMaskDirective)),
    multi: true
};
/** @type {?} */
const DEFAULT_IMASK_ELEMENT = (/**
 * @param {?} elementRef
 * @return {?}
 */
(elementRef) => elementRef.nativeElement);
const ɵ0 = DEFAULT_IMASK_ELEMENT;
/**
 * @template Opts
 */
export class IMaskDirective {
    /**
     * @param {?} _elementRef
     * @param {?} _renderer
     * @param {?} _factory
     * @param {?} _compositionMode
     */
    constructor(_elementRef, _renderer, _factory, _compositionMode) {
        this._elementRef = _elementRef;
        this._renderer = _renderer;
        this._factory = _factory;
        this._compositionMode = _compositionMode;
        // init here to support AOT (TODO may be will work with ng-packgr - need to check)
        this.onTouched = (/**
         * @return {?}
         */
        () => { });
        this.onChange = (/**
         * @return {?}
         */
        () => { });
        this.imaskElement = DEFAULT_IMASK_ELEMENT;
        this.accept = new EventEmitter();
        this.complete = new EventEmitter();
        this._viewInitialized = false;
        this._composing = false;
        this._writing = false;
        if (this._compositionMode == null) {
            this._compositionMode = !this._isAndroid();
        }
    }
    /**
     * @return {?}
     */
    get element() {
        return this.imaskElement(this._elementRef, this);
    }
    /**
     * @return {?}
     */
    get maskValue() {
        if (!this.maskRef)
            return this.element.value;
        if (this.unmask === 'typed')
            return this.maskRef.typedValue;
        if (this.unmask)
            return this.maskRef.unmaskedValue;
        return this.maskRef.value;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    set maskValue(value) {
        if (this.maskRef) {
            if (this.unmask === 'typed')
                this.maskRef.typedValue = value;
            else if (this.unmask)
                this.maskRef.unmaskedValue = value;
            else
                this.maskRef.value = value;
        }
        else {
            this._renderer.setProperty(this.element, 'value', value);
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        if (this.imask)
            this.initMask();
        this._viewInitialized = true;
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.elementRef && !this.imaskElement)
            this.imaskElement = DEFAULT_IMASK_ELEMENT;
        if (!changes.imask || !this._viewInitialized)
            return;
        if (this.imask) {
            if (this.maskRef)
                this.maskRef.updateOptions(this.imask);
            else {
                this.initMask();
                this.onChange(this.maskValue);
            }
        }
        else {
            this.destroyMask();
        }
    }
    /**
     * @return {?}
     */
    destroyMask() {
        if (this.maskRef) {
            this.maskRef.destroy();
            delete this.maskRef;
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroyMask();
        this.accept.complete();
        this.complete.complete();
    }
    /**
     * @param {?} value
     * @return {?}
     */
    beginWrite(value) {
        this._writing = true;
        this._writingValue = value;
    }
    /**
     * @return {?}
     */
    endWrite() {
        this._writing = false;
        return this._writingValue;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    writeValue(value) {
        value = value == null ? '' : value;
        if (this.maskRef) {
            this.beginWrite(value);
            if (this.maskValue !== value ||
                // handle cases like Number('') === 0,
                // for details see https://github.com/uNmAnNeR/imaskjs/issues/134
                (typeof value !== 'string' && this.maskRef.value === '') &&
                    !this.maskRef.el.isActive) {
                this.maskValue = value;
            }
        }
        else {
            this._renderer.setProperty(this.element, 'value', value);
        }
    }
    /**
     * @return {?}
     */
    _onAccept() {
        /** @type {?} */
        const value = this.maskValue;
        // if value was not changed during writing don't fire events
        // for details see https://github.com/uNmAnNeR/imaskjs/issues/136
        if (this._writing && value === this.endWrite())
            return;
        this.onChange(value);
        this.accept.emit(value);
    }
    /**
     * @return {?}
     */
    _onComplete() {
        this.complete.emit(this.maskValue);
    }
    /**
     * @private
     * @return {?}
     */
    initMask() {
        this.maskRef = this._factory.create(this.element, (/** @type {?} */ (this.imask)))
            .on('accept', this._onAccept.bind(this))
            .on('complete', this._onComplete.bind(this));
    }
    /**
     * @param {?} isDisabled
     * @return {?}
     */
    setDisabledState(isDisabled) {
        this._renderer.setProperty(this.element, 'disabled', isDisabled);
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnChange(fn) { this.onChange = fn; }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerOnTouched(fn) { this.onTouched = fn; }
    /**
     * @param {?} value
     * @return {?}
     */
    _handleInput(value) {
        // if mask is attached all input goes throw mask
        if (this.maskRef)
            return;
        if (!this._compositionMode || (this._compositionMode && !this._composing)) {
            this.onChange(value);
        }
    }
    /**
     * @return {?}
     */
    _compositionStart() { this._composing = true; }
    /**
     * @param {?} value
     * @return {?}
     */
    _compositionEnd(value) {
        this._composing = false;
        this._compositionMode && this._handleInput(value);
    }
    /**
     * @private
     * @return {?}
     */
    _isAndroid() {
        return /android (\d+)/.test(navigator.userAgent.toLowerCase());
    }
}
IMaskDirective.decorators = [
    { type: Directive, args: [{
                selector: '[imask]',
                host: {
                    '(input)': '_handleInput($event.target.value)',
                    '(blur)': 'onTouched()',
                    '(compositionstart)': '_compositionStart()',
                    '(compositionend)': '_compositionEnd($event.target.value)'
                },
                providers: [MASKEDINPUT_VALUE_ACCESSOR]
            },] }
];
/** @nocollapse */
IMaskDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: IMaskFactory },
    { type: Boolean, decorators: [{ type: Optional }, { type: Inject, args: [COMPOSITION_BUFFER_MODE,] }] }
];
IMaskDirective.propDecorators = {
    imask: [{ type: Input }],
    unmask: [{ type: Input }],
    imaskElement: [{ type: Input }],
    accept: [{ type: Output }],
    complete: [{ type: Output }]
};
if (false) {
    /** @type {?} */
    IMaskDirective.prototype.maskRef;
    /** @type {?} */
    IMaskDirective.prototype.onTouched;
    /** @type {?} */
    IMaskDirective.prototype.onChange;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._viewInitialized;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._composing;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._writingValue;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._writing;
    /** @type {?} */
    IMaskDirective.prototype.imask;
    /** @type {?} */
    IMaskDirective.prototype.unmask;
    /** @type {?} */
    IMaskDirective.prototype.imaskElement;
    /** @type {?} */
    IMaskDirective.prototype.accept;
    /** @type {?} */
    IMaskDirective.prototype.complete;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._elementRef;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._renderer;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._factory;
    /**
     * @type {?}
     * @private
     */
    IMaskDirective.prototype._compositionMode;
}
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hc2suZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vYW5ndWxhci1pbWFzay8iLCJzb3VyY2VzIjpbImltYXNrLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQVksU0FBUyxFQUNyRSxZQUFZLEVBQ1osUUFBUSxFQUFFLE1BQU0sR0FDakIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUF3Qix1QkFBdUIsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRWxHLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQzs7QUFHN0MsTUFBTSxPQUFPLDBCQUEwQixHQUFhO0lBQ2xELE9BQU8sRUFBRSxpQkFBaUI7SUFDMUIsV0FBVyxFQUFFLFVBQVU7OztJQUFDLEdBQUcsRUFBRSxDQUFDLGNBQWMsRUFBQztJQUM3QyxLQUFLLEVBQUUsSUFBSTtDQUNaOztNQUVLLHFCQUFxQjs7OztBQUFHLENBQUMsVUFBZSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFBOzs7OztBQVczRSxNQUFNLE9BQU8sY0FBYzs7Ozs7OztJQWV6QixZQUFvQixXQUF1QixFQUN2QixTQUFvQixFQUNwQixRQUFzQixFQUN1QixnQkFBeUI7UUFIdEUsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDdkIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixhQUFRLEdBQVIsUUFBUSxDQUFjO1FBQ3VCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBUztRQUN4RixrRkFBa0Y7UUFDbEYsSUFBSSxDQUFDLFNBQVM7OztRQUFHLEdBQUcsRUFBRSxHQUFFLENBQUMsQ0FBQSxDQUFDO1FBQzFCLElBQUksQ0FBQyxRQUFROzs7UUFBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUEsQ0FBQztRQUN6QixJQUFJLENBQUMsWUFB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QUFvQzs7SUFDcEMsa0NBQXNDOzs7OztJQUUxQixxQ0FBK0I7Ozs7O0lBQy9CLG1DQUE0Qjs7Ozs7SUFDNUIsa0NBQThCOzs7OztJQUM5QiwwQ0FBOEUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgSW5wdXQsIE91dHB1dCwgZm9yd2FyZFJlZiwgUHJvdmlkZXIsIFJlbmRlcmVyMixcclxuICBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSwgT25DaGFuZ2VzLCBBZnRlclZpZXdJbml0LFxyXG4gIE9wdGlvbmFsLCBJbmplY3QsIFNpbXBsZUNoYW5nZXMsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE5HX1ZBTFVFX0FDQ0VTU09SLCBDb250cm9sVmFsdWVBY2Nlc3NvciwgQ09NUE9TSVRJT05fQlVGRkVSX01PREUgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcblxyXG5pbXBvcnQge0lNYXNrRmFjdG9yeX0gZnJvbSBcIi4vaW1hc2stZmFjdG9yeVwiO1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBNQVNLRURJTlBVVF9WQUxVRV9BQ0NFU1NPUjogUHJvdmlkZXIgPSB7XHJcbiAgcHJvdmlkZTogTkdfVkFMVUVfQUNDRVNTT1IsXHJcbiAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gSU1hc2tEaXJlY3RpdmUpLFxyXG4gIG11bHRpOiB0cnVlXHJcbn07XHJcblxyXG5jb25zdCBERUZBVUxUX0lNQVNLX0VMRU1FTlQgPSAoZWxlbWVudFJlZjogYW55KSA9PiBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2ltYXNrXScsXHJcbiAgaG9zdDoge1xyXG4gICAgJyhpbnB1dCknOiAnX2hhbmRsZUlucHV0KCRldmVudC50YXJnZXQudmFsdWUpJyxcclxuICAgICcoYmx1ciknOiAnb25Ub3VjaGVkKCknLFxyXG4gICAgJyhjb21wb3NpdGlvbnN0YXJ0KSc6ICdfY29tcG9zaXRpb25TdGFydCgpJyxcclxuICAgICcoY29tcG9zaXRpb25lbmQpJzogJ19jb21wb3NpdGlvbkVuZCgkZXZlbnQudGFyZ2V0LnZhbHVlKSdcclxuICB9LFxyXG4gIHByb3ZpZGVyczogW01BU0tFRElOUFVUX1ZBTFVFX0FDQ0VTU09SXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgSU1hc2tEaXJlY3RpdmU8T3B0cyBleHRlbmRzIGltcG9ydCgnaW1hc2snKS5kZWZhdWx0LkFueU1hc2tlZE9wdGlvbnM+IGltcGxlbWVudHMgQ29udHJvbFZhbHVlQWNjZXNzb3IsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcclxuICBtYXNrUmVmPzogSU1hc2suSW5wdXRNYXNrPE9wdHM+O1xyXG4gIG9uVG91Y2hlZDogYW55O1xyXG4gIG9uQ2hhbmdlOiBhbnk7XHJcbiAgcHJpdmF0ZSBfdmlld0luaXRpYWxpemVkOiBib29sZWFuO1xyXG4gIHByaXZhdGUgX2NvbXBvc2luZzogYm9vbGVhbjtcclxuICBwcml2YXRlIF93cml0aW5nVmFsdWU6IGFueTtcclxuICBwcml2YXRlIF93cml0aW5nOiBib29sZWFuO1xyXG5cclxuICBASW5wdXQoKSBpbWFzaz86IE9wdHM7XHJcbiAgQElucHV0KCkgdW5tYXNrPzogYm9vbGVhbnwndHlwZWQnO1xyXG4gIEBJbnB1dCgpIGltYXNrRWxlbWVudDogKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIGRpcmVjdGl2ZVJlZjogYW55KSA9PiBJTWFzay5NYXNrRWxlbWVudDtcclxuICBAT3V0cHV0KCkgYWNjZXB0OiBFdmVudEVtaXR0ZXI8YW55PjtcclxuICBAT3V0cHV0KCkgY29tcGxldGU6IEV2ZW50RW1pdHRlcjxhbnk+O1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9lbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgX3JlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfZmFjdG9yeTogSU1hc2tGYWN0b3J5LFxyXG4gICAgICAgICAgICAgIEBPcHRpb25hbCgpIEBJbmplY3QoQ09NUE9TSVRJT05fQlVGRkVSX01PREUpIHByaXZhdGUgX2NvbXBvc2l0aW9uTW9kZTogYm9vbGVhbikge1xyXG4gICAgLy8gaW5pdCBoZXJlIHRvIHN1cHBvcnQgQU9UIChUT0RPIG1heSBiZSB3aWxsIHdvcmsgd2l0aCBuZy1wYWNrZ3IgLSBuZWVkIHRvIGNoZWNrKVxyXG4gICAgdGhpcy5vblRvdWNoZWQgPSAoKSA9PiB7fTtcclxuICAgIHRoaXMub25DaGFuZ2UgPSAoKSA9PiB7fTtcclxuICAgIHRoaXMuaW1hc2tFbGVtZW50ID0gREVGQVVMVF9JTUFTS19FTEVNRU5UO1xyXG4gICAgdGhpcy5hY2NlcHQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICB0aGlzLmNvbXBsZXRlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gICAgdGhpcy5fdmlld0luaXRpYWxpemVkID0gZmFsc2U7XHJcbiAgICB0aGlzLl9jb21wb3NpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuX3dyaXRpbmcgPSBmYWxzZTtcclxuXHJcbiAgICBpZiAodGhpcy5fY29tcG9zaXRpb25Nb2RlID09IG51bGwpIHtcclxuICAgICAgdGhpcy5fY29tcG9zaXRpb25Nb2RlID0gIXRoaXMuX2lzQW5kcm9pZCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IGVsZW1lbnQgKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW1hc2tFbGVtZW50KHRoaXMuX2VsZW1lbnRSZWYsIHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IG1hc2tWYWx1ZSAoKTogYW55IHtcclxuICAgIGlmICghdGhpcy5tYXNrUmVmKSByZXR1cm4gdGhpcy5lbGVtZW50LnZhbHVlO1xyXG5cclxuICAgIGlmICh0aGlzLnVubWFzayA9PT0gJ3R5cGVkJykgcmV0dXJuIHRoaXMubWFza1JlZi50eXBlZFZhbHVlO1xyXG4gICAgaWYgKHRoaXMudW5tYXNrKSByZXR1cm4gdGhpcy5tYXNrUmVmLnVubWFza2VkVmFsdWU7XHJcbiAgICByZXR1cm4gdGhpcy5tYXNrUmVmLnZhbHVlO1xyXG4gIH1cclxuXHJcbiAgc2V0IG1hc2tWYWx1ZSAodmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHRoaXMubWFza1JlZikge1xyXG4gICAgICBpZiAodGhpcy51bm1hc2sgPT09ICd0eXBlZCcpIHRoaXMubWFza1JlZi50eXBlZFZhbHVlID0gdmFsdWU7XHJcbiAgICAgIGVsc2UgaWYgKHRoaXMudW5tYXNrKSB0aGlzLm1hc2tSZWYudW5tYXNrZWRWYWx1ZSA9IHZhbHVlO1xyXG4gICAgICBlbHNlIHRoaXMubWFza1JlZi52YWx1ZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbGVtZW50LCAndmFsdWUnLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICBpZiAodGhpcy5pbWFzaykgdGhpcy5pbml0TWFzaygpO1xyXG5cclxuICAgIHRoaXMuX3ZpZXdJbml0aWFsaXplZCA9IHRydWU7XHJcbiAgfVxyXG5cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgICBpZiAoY2hhbmdlcy5lbGVtZW50UmVmICYmICF0aGlzLmltYXNrRWxlbWVudCkgdGhpcy5pbWFza0VsZW1lbnQgPSBERUZBVUxUX0lNQVNLX0VMRU1FTlQ7XHJcblxyXG4gICAgaWYgKCFjaGFuZ2VzLmltYXNrIHx8ICF0aGlzLl92aWV3SW5pdGlhbGl6ZWQpIHJldHVybjtcclxuXHJcbiAgICBpZiAodGhpcy5pbWFzaykge1xyXG4gICAgICBpZiAodGhpcy5tYXNrUmVmKSB0aGlzLm1hc2tSZWYudXBkYXRlT3B0aW9ucyh0aGlzLmltYXNrKTtcclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgdGhpcy5pbml0TWFzaygpO1xyXG4gICAgICAgIHRoaXMub25DaGFuZ2UodGhpcy5tYXNrVmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmRlc3Ryb3lNYXNrKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBkZXN0cm95TWFzayAoKSB7XHJcbiAgICBpZiAodGhpcy5tYXNrUmVmKSB7XHJcbiAgICAgIHRoaXMubWFza1JlZi5kZXN0cm95KCk7XHJcbiAgICAgIGRlbGV0ZSB0aGlzLm1hc2tSZWY7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSAoKSB7XHJcbiAgICB0aGlzLmRlc3Ryb3lNYXNrKCk7XHJcbiAgICB0aGlzLmFjY2VwdC5jb21wbGV0ZSgpO1xyXG4gICAgdGhpcy5jb21wbGV0ZS5jb21wbGV0ZSgpO1xyXG4gIH1cclxuXHJcbiAgYmVnaW5Xcml0ZSAodmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgdGhpcy5fd3JpdGluZyA9IHRydWU7XHJcbiAgICB0aGlzLl93cml0aW5nVmFsdWUgPSB2YWx1ZTtcclxuICB9XHJcblxyXG4gIGVuZFdyaXRlICgpOiBhbnkge1xyXG4gICAgdGhpcy5fd3JpdGluZyA9IGZhbHNlO1xyXG4gICAgcmV0dXJuIHRoaXMuX3dyaXRpbmdWYWx1ZTtcclxuICB9XHJcblxyXG4gIHdyaXRlVmFsdWUodmFsdWU6IGFueSkge1xyXG4gICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gJycgOiB2YWx1ZTtcclxuXHJcbiAgICBpZiAodGhpcy5tYXNrUmVmKSB7XHJcbiAgICAgIHRoaXMuYmVnaW5Xcml0ZSh2YWx1ZSk7XHJcblxyXG4gICAgICBpZiAodGhpcy5tYXNrVmFsdWUgIT09IHZhbHVlIHx8XHJcbiAgICAgICAgLy8gaGFuZGxlIGNhc2VzIGxpa2UgTnVtYmVyKCcnKSA9PT0gMCxcclxuICAgICAgICAvLyBmb3IgZGV0YWlscyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3VObUFuTmVSL2ltYXNranMvaXNzdWVzLzEzNFxyXG4gICAgICAgICh0eXBlb2YgdmFsdWUgIT09ICdzdHJpbmcnICYmIHRoaXMubWFza1JlZi52YWx1ZSA9PT0gJycpICYmXHJcbiAgICAgICAgICAhdGhpcy5tYXNrUmVmLmVsLmlzQWN0aXZlXHJcbiAgICAgICkge1xyXG4gICAgICAgIHRoaXMubWFza1ZhbHVlID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX3JlbmRlcmVyLnNldFByb3BlcnR5KHRoaXMuZWxlbWVudCwgJ3ZhbHVlJywgdmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgX29uQWNjZXB0ICgpIHtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5tYXNrVmFsdWU7XHJcbiAgICAvLyBpZiB2YWx1ZSB3YXMgbm90IGNoYW5nZWQgZHVyaW5nIHdyaXRpbmcgZG9uJ3QgZmlyZSBldmVudHNcclxuICAgIC8vIGZvciBkZXRhaWxzIHNlZSBodHRwczovL2dpdGh1Yi5jb20vdU5tQW5OZVIvaW1hc2tqcy9pc3N1ZXMvMTM2XHJcbiAgICBpZiAodGhpcy5fd3JpdGluZyAmJiB2YWx1ZSA9PT0gdGhpcy5lbmRXcml0ZSgpKSByZXR1cm47XHJcbiAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcclxuICAgIHRoaXMuYWNjZXB0LmVtaXQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgX29uQ29tcGxldGUgKCkge1xyXG4gICAgdGhpcy5jb21wbGV0ZS5lbWl0KHRoaXMubWFza1ZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdE1hc2sgKCkge1xyXG4gICAgdGhpcy5tYXNrUmVmID0gdGhpcy5fZmFjdG9yeS5jcmVhdGUodGhpcy5lbGVtZW50LCB0aGlzLmltYXNrIGFzIE9wdHMpXHJcbiAgICAgIC5vbignYWNjZXB0JywgdGhpcy5fb25BY2NlcHQuYmluZCh0aGlzKSlcclxuICAgICAgLm9uKCdjb21wbGV0ZScsIHRoaXMuX29uQ29tcGxldGUuYmluZCh0aGlzKSk7XHJcbiAgfVxyXG5cclxuICBzZXREaXNhYmxlZFN0YXRlIChpc0Rpc2FibGVkOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLl9yZW5kZXJlci5zZXRQcm9wZXJ0eSh0aGlzLmVsZW1lbnQsICdkaXNhYmxlZCcsIGlzRGlzYWJsZWQpXHJcbiAgfVxyXG5cclxuICByZWdpc3Rlck9uQ2hhbmdlKGZuOiAoXzogYW55KSA9PiB2b2lkKTogdm9pZCB7IHRoaXMub25DaGFuZ2UgPSBmbiB9XHJcbiAgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IHZvaWQpOiB2b2lkIHsgdGhpcy5vblRvdWNoZWQgPSBmbiB9XHJcblxyXG4gIF9oYW5kbGVJbnB1dCh2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICAvLyBpZiBtYXNrIGlzIGF0dGFjaGVkIGFsbCBpbnB1dCBnb2VzIHRocm93IG1hc2tcclxuICAgIGlmICh0aGlzLm1hc2tSZWYpIHJldHVybjtcclxuXHJcbiAgICBpZiAoIXRoaXMuX2NvbXBvc2l0aW9uTW9kZSB8fCAodGhpcy5fY29tcG9zaXRpb25Nb2RlICYmICF0aGlzLl9jb21wb3NpbmcpKSB7XHJcbiAgICAgIHRoaXMub25DaGFuZ2UodmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgX2NvbXBvc2l0aW9uU3RhcnQoKTogdm9pZCB7IHRoaXMuX2NvbXBvc2luZyA9IHRydWU7IH1cclxuXHJcbiAgX2NvbXBvc2l0aW9uRW5kKHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIHRoaXMuX2NvbXBvc2luZyA9IGZhbHNlO1xyXG4gICAgdGhpcy5fY29tcG9zaXRpb25Nb2RlICYmIHRoaXMuX2hhbmRsZUlucHV0KHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2lzQW5kcm9pZCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiAvYW5kcm9pZCAoXFxkKykvLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKTtcclxuICB9XHJcbn1cclxuIl19